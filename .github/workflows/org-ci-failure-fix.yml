name: Org CI Failure Auto-Fix

on:
  workflow_call:
    inputs:
      workflow_name:
        description: 'Name of the failed workflow'
        required: true
        type: string
      run_id:
        description: 'Workflow run ID'
        required: true
        type: number
      head_branch:
        description: 'Branch where the failure occurred'
        required: true
        type: string
      head_sha:
        description: 'Commit SHA'
        required: true
        type: string
      pr_number:
        description: 'PR number if from a PR'
        required: false
        type: number
        default: 0
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        description: 'Claude Code OAuth token'
        required: true
      GH_TOKEN:
        description: 'GitHub token for API access'
        required: true

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write
  id-token: write

concurrency:
  group: ci-fix-${{ github.repository }}-${{ inputs.head_branch }}
  cancel-in-progress: false

jobs:
  auto-fix:
    runs-on: arc-happyvertical
    timeout-minutes: 20
    # Skip if branch is already a fix branch (prevent infinite loops)
    if: "!startsWith(inputs.head_branch, 'claude-auto-fix-')"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
          elif [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "package.json" ]; then
            pnpm install || npm install
          fi
        continue-on-error: true

      - name: Get Failure Logs
        id: logs
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Fetching failure logs for run ${{ inputs.run_id }}..."
          gh run view ${{ inputs.run_id }} --log-failed > failure_logs.txt 2>&1 || true

          # Also get job info
          gh run view ${{ inputs.run_id }} --json jobs > run_info.json 2>&1 || true

          echo "Logs saved to failure_logs.txt"
          head -100 failure_logs.txt || true

      - name: Run Claude Auto-Fix
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          timeout_minutes: 15
          prompt: |
            REPO: ${{ github.repository }}
            WORKFLOW: ${{ inputs.workflow_name }}
            BRANCH: ${{ inputs.head_branch }}
            COMMIT: ${{ inputs.head_sha }}
            PR_NUMBER: ${{ inputs.pr_number }}

            The CI workflow "${{ inputs.workflow_name }}" has failed on branch "${{ inputs.head_branch }}".

            Read the failure logs from: failure_logs.txt
            Read run info from: run_info.json

            Execute the fix-ci command:
            /fix-ci

            Important:
            - Make minimal changes to fix the specific issue
            - Run verification commands after fixing
            - If you cannot fix the issue, create a comment explaining why
            - Do NOT force push or rewrite history
            - Commit with conventional commit format: fix: [description]

          allowed_tools: |
            Read,Write,Edit,Bash(git:*),Bash(pnpm:*),Bash(npm:*),Bash(npx:*),Bash(node:*),Bash(bun:*),Grep,Glob,Bash(gh pr:*),Bash(gh issue:*)

      - name: Post Comment on Failure
        if: failure() && inputs.pr_number != 0
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh pr comment ${{ inputs.pr_number }} --body "## CI Auto-Fix Attempted

          I attempted to automatically fix the CI failure but was unsuccessful.

          **Workflow**: ${{ inputs.workflow_name }}
          **Run**: [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ inputs.run_id }})

          Please review the failure logs and fix manually.

          ---
          *Automated by Claude*"
